name: Deploy to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: SSH into EC2 and deploy container
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_PUBLIC_IP }}
        username: ubuntu
        key: ${{ secrets.SSH }}
        debug: true
        script: |
          set -e  # Exit immediately on error
          echo "Updating system packages..."
          sudo apt update -y
          sudo apt install -y docker.io awscli
          sudo systemctl start docker
          sudo systemctl enable docker
          echo "Connected successfully!"
          docker ps || true

          # Authenticate with ECR using the instance's IAM role
          echo "Logging into ECR using EC2 IAM role..."
          aws ecr get-login-password --region us-west-2 | sudo docker login --username AWS --password-stdin 429128461930.dkr.ecr.us-west-2.amazonaws.com

          echo "Stopping old container if it exists..."
          sudo docker stop mentorship-wk2 || true
          sudo docker rm mentorship-wk2 || true

          echo "Pulling latest Docker image from ECR..."
          sudo docker pull 429128461930.dkr.ecr.us-west-2.amazonaws.com/mentorship-wk2:${{ github.sha }}

          echo "Starting new container..."
          sudo docker run -d -p 5000:5000 --name mentorship-wk2 429128461930.dkr.ecr.us-west-2.amazonaws.com/mentorship-wk2:${{ github.sha }}

          echo "Deployment successful! Running containers:"
          docker ps
