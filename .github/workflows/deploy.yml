name: Deploy to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-region: us-west-2
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: SSH into EC2 and deploy container
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_PUBLIC_IP }}
        username: ubuntu
        key: ${{ secrets.SSH }}
        debug: true
        script: |
          set -e  # stop on error
          
          # --- Update & install dependencies ---
          sudo apt update -y
          sudo apt install -y docker.io awscli

          # --- Enable & start docker ---
          sudo systemctl enable docker
          sudo systemctl start docker

          # --- Allow ubuntu user to use docker without sudo ---
          sudo usermod -aG docker ubuntu
          newgrp docker <<EONG
          
          echo "Connected successfully!"
          docker ps

          # --- Log in to ECR ---
          aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 429128461930.dkr.ecr.us-west-2.amazonaws.com
          
          # --- Deploy container ---
          docker pull 429128461930.dkr.ecr.us-west-2.amazonaws.com/myflaskrun:${{ github.sha }}
          docker stop myflaskrun || true
          docker rm myflaskrun || true
          docker run -d -p 5000:5000 --name myflaskrun 429128461930.dkr.ecr.us-west-2.amazonaws.com/myflaskrun:${{ github.sha }}
          
          EONG
